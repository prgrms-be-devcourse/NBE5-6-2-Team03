<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>여행지 지도</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      body {
        overflow: hidden; /* 필요 시 스크롤 막기 */
      }

      .container {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;      /* 뷰포트 전체 너비로 */
        max-width: none;   /* 혹시 있을 max-width 제한 제거 */
      }

      .sidebar {
        flex-basis: 30%;
        min-width: 250px;
        max-width: 400px;
        background-color: var(--bs-light);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }

      #active-cards-container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        min-height: 0; /* 중요 */
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #aaf;
        gap: 8px;
      }

      .search-form {
        flex-shrink: 0;
      }

      .card-list {
        flex-grow: 1;
        overflow-y: auto;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }

      .card.active {
        background-color: #f0f8ff;
        transition: background-color 0.3s ease;
      }

      .pagination-wrapper {
        flex-shrink: 0;
      }

      .map {
        flex-grow: 1;
        min-height: 0; /* 중요 */
        /* height: 100%; 대신 */
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          flex-basis: auto;
          width: 100%;
          max-width: none;
          height: auto;
          max-height: 40vh;
        }

        .map {
          height: 60vh;
        }
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-select {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid var(--bs-border-color);
        border-radius: var(--bs-border-radius);
      }

      .btn-primary {
        background-color: var(--bs-primary);
        border: none;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: var(--bs-border-radius);
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .btn-primary:hover {
        background-color: var(--bs-link-hover-color);
      }

      .card {
        background-color: #fff;
        border: 1px solid var(--bs-border-color);
        border-radius: var(--bs-border-radius);
        padding: 0.5rem 0.75rem;  /* 패딩 축소 */
        margin-bottom: 0.5rem;    /* 카드 간 간격 축소 */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        font-size: 0.9rem;         /* 글씨 크기 약간 줄이기 (선택사항) */
        line-height: 1.3;          /* 행간 조정으로 압축 효과 */
      }

      .pagination {
        flex-wrap: wrap;
      }

      #active-cards-container {
        flex-basis: 15%;
        max-width: 200px; /* 사이드바의 절반 정도 */
        background-color: #fff;
        padding: 10px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        gap: 8px;
        box-shadow: 1px 0 4px rgba(0, 0, 0, 0.05);
      }

      #active-cards-container .mini-card {
        background-color: #aaf;
        width: calc(100% - 4px); /* 부모보다 4px 작게 */
        padding: 0.5rem;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
      }

      #active-cards-container .mini-card.active {
        background-color: #f0f8ff;
      }

    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="search-form">
            <form th:action="@{/map}" method="get">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="form-group">
                    <label for="countryRequest">국가 선택</label>
                    <select name="countryRequest" id="countryRequest" class="form-select">
                        <option value="">전체 국가</option>
                        <option th:each="country : ${countries}"
                                th:value="${country}"
                                th:text="${country}"
                                th:selected="${param.countryRequest == country}">
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cityRequest">도시 선택</label>
                    <select name="cityRequest" id="cityRequest" class="form-select">
                        <option value="">전체 도시</option>
                        <option th:each="city : ${cities}"
                                th:value="${city}"
                                th:text="${city}"
                                th:selected="${param.cityRequest == city}">
                        </option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">검색</button>
            </form>
        </div>

        <div class="card-list">
            <div th:each="place : ${mapPage.content}"
                 th:id="'card-' + ${place.id}"
                 class="card">
                <p th:text="${place.country}">국가</p>
                <p th:text="${place.city}">도시</p>
                <p th:text="${place.placeName}">여행지 이름</p>
            </div>
        </div>

        <div class="pagination-wrapper">
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${mapPage.first} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/map(page=${mapPage.number > 0 ? mapPage.number - 1 : 0}, size=${mapPage.size}, countryRequest=${param.countryRequest}, cityRequest=${param.cityRequest})}">
                            이전
                        </a>
                    </li>

                    <th:block th:with="start=${T(java.lang.Math).max(0, mapPage.number - 2)},
                             end=${T(java.lang.Math).min(mapPage.totalPages - 1, mapPage.number + 2)}">
                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(start, end)}"
                            th:classappend="${i == mapPage.number} ? 'active'">
                            <a class="page-link"
                               th:href="@{/map(page=${i}, size=${mapPage.size}, countryRequest=${param.countryRequest}, cityRequest=${param.cityRequest})}"
                               th:text="${i + 1}">1</a>
                        </li>
                    </th:block>

                    <li class="page-item" th:classappend="${mapPage.last} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/map(page=${mapPage.number + 1 >= mapPage.totalPages ? mapPage.number : mapPage.number + 1}, size=${mapPage.size}, countryRequest=${param.countryRequest}, cityRequest=${param.cityRequest})}">
                            다음
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <div id="active-cards-container">
        <!-- JS로 활성화된 카드 미니 아이템을 여기 추가 -->
    </div>
    <div class="map" id="map"></div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const places = /*[[${mapPage.content}]]*/ [];
      /*]]>*/
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDItF6jDbw7qRmIKQy6QQbioL5OfeQjiyI&v=beta&libraries=marker"></script>
    <script src="https://unpkg.com/@googlemaps/marker-advanced"></script>

    <script>
      function initMap() {
        const defaultPosition = { lat: 37.5665, lng: 126.9780 };

        const mapCenterPosition = places.length > 0
            ? { lat: places[0].latitude, lng: places[0].longitude }
            : defaultPosition;

        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: mapCenterPosition,
          mapId: "DEMO_MAP_ID",
        });

        const defaultMarker = new google.maps.marker.PinElement({
          background: "red",
          borderColor: "white",
          glyph: "",
          scale: 1.3,
        });

        function createSmallRedDot() {
          const div = document.createElement("div");
          div.style.width = "16px";
          div.style.height = "16px";
          div.style.borderRadius = "50%";
          div.style.backgroundColor = "blue";
          div.style.boxShadow = "0 0 2px rgba(0,0,0,0.5)";
          return div;
        }

        const markers = new Map();
        const activePlaceIds = new Set();

        function updateActiveCardsUI() {
          const container = document.getElementById('active-cards-container');
          if (!container) return;

          container.innerHTML = '';

          activePlaceIds.forEach((id) => {
            const place = places.find(p => p.id === id);
            if (!place) return;

            const miniCard = document.createElement('div');
            miniCard.className = 'mini-card active';
            miniCard.textContent = place.placeName;

            miniCard.onclick = () => {
              const marker = markers.get(id);
              if(marker){
                marker.content = createSmallRedDot();
                activePlaceIds.delete(id);
                updateActiveCardsUI();

                const card = document.getElementById(`card-${id}`);
                if(card) card.classList.remove('active');
              }
            };

            container.appendChild(miniCard);
          });
        }

        function toggleActivePlace(placeId) {
          const marker = markers.get(placeId);
          const card = document.getElementById(`card-${placeId}`);

          if (activePlaceIds.has(placeId)) {
            activePlaceIds.delete(placeId);
            if(marker) marker.content = createSmallRedDot();
            if(card) card.classList.remove('active');
          } else {
            activePlaceIds.add(placeId);
            if(marker) marker.content = defaultMarker.element;
            if(card) {
              card.classList.add('active');
              card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }

          updateActiveCardsUI();
        }

        places.forEach((place) => {
          const position = { lat: place.latitude, lng: place.longitude };
          const smallIcon = createSmallRedDot();

          const marker = new google.maps.marker.AdvancedMarkerElement({
            map,
            position,
            title: place.placeName,
            content: smallIcon,
          });

          markers.set(place.id, marker);

          marker.element.addEventListener("mouseenter", () => {
            if (!activePlaceIds.has(place.id)) marker.content = defaultMarker.element;
          });

          marker.element.addEventListener("mouseleave", () => {
            if (!activePlaceIds.has(place.id)) marker.content = smallIcon;
          });

          marker.element.addEventListener("click", () => {
            toggleActivePlace(place.id);
          });
        });

        places.forEach((place) => {
          const card = document.getElementById(`card-${place.id}`);
          if (card) {
            card.addEventListener("click", () => {
              toggleActivePlace(place.id);
            });
          }
        });

        updateActiveCardsUI();
      }

      window.addEventListener("load", initMap);
    </script>
</div>
</body>
</html>

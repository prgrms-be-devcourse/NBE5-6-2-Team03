<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>place list</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .place-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
    }
    .place-info {
      flex-grow: 1;
    }
    .place-id {
      font-size: 0.85rem;
    }
  </style>

</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="display-5 text-center text-primary mb-4">🗺️ 등록된 장소 목록</h1>

  <!-- ✅ 필터 Select -->
  <div class="row mb-4">
    <div class="col-md-4">
      <select id="countryFilter" class="form-select">
        <option value="">🌐 모든 국가 보기</option>
        <option th:each="country : ${countries}" th:value="${country}" th:text="${country}"></option>
      </select>
    </div>
    <div class="col-md-4">
      <select id="cityFilter" class="form-select">
        <option value="">🏙️ 모든 도시 보기</option>
        <!-- JavaScript로 동적으로 채움 -->
      </select>
    </div>
  </div>

  <!-- ✅ 카드 리스트 -->
  <div class="row g-3" id="placeList">
    <div class="col-12" th:each="place : ${places}"
         th:attr="data-country=${place.country}, data-city=${place.city}">
      <div class="card shadow-sm border-0 place-card">
        <div class="place-info">
          <h5 class="text-primary mb-1" th:text="${place.placeName}">장소명</h5>
          <div class="text-muted mb-2">
            <span th:text="${place.city}">도시</span>,
            <span th:text="${place.country}">국가</span>
          </div>
          <div class="mb-1"><strong>위도:</strong> <span th:text="${place.latitude}">lat</span></div>
          <div class="mb-1"><strong>경도:</strong> <span th:text="${place.longitude}">lng</span></div>
        </div>

        <!-- 우측 하단: ID + 버튼 -->
        <div class="text-end text-muted place-id">
          <div>
            ID: <span th:text="${place.placeId}">placeId</span>
          </div>
          <div class="mt-2">
            <a href="#" class="btn btn-sm btn-outline-primary me-1 edit-btn"
               th:attr="data-id=${place.placeId},
              data-name=${place.placeName},
              data-country=${place.country},
              data-city=${place.city},
              data-lat=${place.latitude},
              data-lng=${place.longitude}">
              ✏️ 수정
            </a>
            <a th:href="@{/place/places/{id}/delete(id=${place.placeId})}"
               onclick="return confirm('정말 삭제하시겠습니까?');"
               class="btn btn-sm btn-outline-danger">🗑 삭제</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 수정 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">장소 정보 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="placeId" id="editPlaceId">

          <div class="mb-3">
            <label for="editPlaceName" class="form-label">장소명</label>
            <input type="text" class="form-control" id="editPlaceName" name="placeName" required>
          </div>
          <div class="mb-3">
            <label for="editCountry" class="form-label">국가</label>
            <input type="text" class="form-control" id="editCountry" name="country" required>
          </div>
          <div class="mb-3">
            <label for="editCity" class="form-label">도시</label>
            <input type="text" class="form-control" id="editCity" name="city" required>
          </div>
          <div class="mb-3">
            <label for="editLatitude" class="form-label">위도</label>
            <input type="number" step="any" class="form-control" id="editLatitude" name="latitude" required>
          </div>
          <div class="mb-3">
            <label for="editLongitude" class="form-label">경도</label>
            <input type="number" step="any" class="form-control" id="editLongitude" name="longitude" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </div>
    </form>
  </div>
</div>


<!-- ✅ 필터링 스크립트 -->
<script th:inline="javascript">
  let allPlaces = /*[[${places}]]*/ [];
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const countrySelect = document.getElementById('countryFilter');
    const citySelect = document.getElementById('cityFilter');
    const cards = document.querySelectorAll('#placeList > .col-12');

    function getCitiesByCountry(country) {
      const cities = new Set();
      allPlaces.forEach(place => {
        if (!country || place.country === country) {
          cities.add(place.city);
        }
      });
      return Array.from(cities).sort();
    }

    function updateCityOptions(country) {
      const cities = getCitiesByCountry(country);
      citySelect.innerHTML = '<option value="">🏙️ 모든 도시 보기</option>';
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    }

    function filterCards() {
      const selectedCountry = countrySelect.value;
      const selectedCity = citySelect.value;

      cards.forEach(card => {
        const country = card.getAttribute('data-country');
        const city = card.getAttribute('data-city');
        const show = (!selectedCountry || country === selectedCountry) &&
            (!selectedCity || city === selectedCity);
        card.style.display = show ? 'block' : 'none';
      });
    }

    countrySelect.addEventListener('change', function () {
      updateCityOptions(this.value);
      filterCards();
    });

    citySelect.addEventListener('change', filterCards);

    // 초기 도시 옵션 전체 로딩
    updateCityOptions('');
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const editButtons = document.querySelectorAll('.edit-btn');
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    const form = document.getElementById('editForm');

    editButtons.forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault(); // 기본 링크 방지

        // 데이터 채우기
        document.getElementById('editPlaceId').value = this.dataset.id;
        document.getElementById('editPlaceName').value = this.dataset.name;
        document.getElementById('editCountry').value = this.dataset.country;
        document.getElementById('editCity').value = this.dataset.city;
        document.getElementById('editLatitude').value = this.dataset.lat;
        document.getElementById('editLongitude').value = this.dataset.lng;

        // 폼 action 설정
        form.action = `/place/places/${this.dataset.id}/edit`;

        // 모달 띄우기
        modal.show();
      });
    });
  });
</script>

<!-- Bootstrap JS (필수) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>